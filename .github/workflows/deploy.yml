name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write  # 需要写权限才能推送到 GitHub Pages

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2.1'  # 你可以根据需要更改 Ruby 版本
        bundler-cache: true

    - name: Install dependencies
      run: |
        gem install jekyll-scholar  # 安装 jekyll-scholar 插件
        gem install bibtex-ruby
        bundle install  # 安装所有在 Gemfile 中定义的依赖
        bundle update  

    - name: Fix deprecated File.exists? in jekyll-scholar
      run: |
        # 替换 jekyll-scholar 插件中的所有 File.exists? 为 File.exist?
        sed -i 's/File.exists?/File.exist?/g' vendor/bundle/ruby/3.2.0/gems/jekyll-scholar-5.16.0/lib/jekyll/scholar/utilities.rb

    - name: Build the site
      run: |
        bundle exec jekyll build  # 构建站点

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: _site  # 构建的输出文件夹
